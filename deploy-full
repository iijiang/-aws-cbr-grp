#!/bin/bash
set -e

# 1. Get the first VPC in the account
VPC_ID=$(aws ec2 describe-vpcs \
  --query "Vpcs[0].VpcId" \
  --output text)

# 2. Get first two subnets (different AZs ideally)
SUBNET_IDS=($(aws ec2 describe-subnets \
  --query "Subnets[*].SubnetId" \
  --output text))

# 3. Get the Route53 Hosted Zone ID for iifancy.com
HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
  --dns-name iifancy.com \
  --query "HostedZones[0].Id" \
  --output text | cut -d'/' -f3)

# 4. Get the latest ACM cert for demo.iifancy.com in ap-southeast-2
CERT_ARN=$(aws acm list-certificates \
  --region ap-southeast-2 \
  --query "CertificateSummaryList[?DomainName=='demo.iifancy.com'].CertificateArn | [0]" \
  --output text)

echo "Deploying with:"
echo "  VPC_ID: $VPC_ID"
echo "  SubnetA: ${SUBNET_IDS[0]}"
echo "  SubnetB: ${SUBNET_IDS[1]}"
echo "  HostedZoneId: $HOSTED_ZONE_ID"
echo "  CertificateArn: $CERT_ARN"

# 5. Deploy CloudFormation stack
aws cloudformation deploy \
  --template-file aws/node-demo-app-fargate-full.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --stack-name NodeDemoApp \
  --parameter-overrides \
    VPC=$VPC_ID \
    SubnetA=${SUBNET_IDS[0]} \
    SubnetB=${SUBNET_IDS[1]} \
    DomainName=demo.iifancy.com \
    HostedZoneId=$HOSTED_ZONE_ID \
    CertificateArn=$CERT_ARN
